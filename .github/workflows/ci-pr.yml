name: CI - Pull Request Checks

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - 'models/**'
      - 'api/**'
      - '.github/workflows/**'

env:
  TERRAFORM_VERSION: '1.5.7'
  PYTHON_VERSION: '3.11'
  TF_IN_AUTOMATION: true

jobs:
  
  terraform-validate:
    name: Terraform Lint & Validate
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        environment: [dev, staging, prod]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: terraform/
        continue-on-error: true
      
      - name: Terraform Init
        id: init
        run: terraform init -backend=false
        working-directory: terraform/environments/${{ matrix.environment }}
      
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: terraform/environments/${{ matrix.environment }}
      
      - name: Post validation results to PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå \`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è \`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ \`${{ steps.validate.outcome }}\`
            
            <details><summary>Validation Output</summary>
            
            \`\`\`
            ${{ steps.validate.outputs.stdout }}
            \`\`\`
            
            </details>
            
            Environment: **${{ matrix.environment }}**
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  
  terraform-security:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform/
          soft_fail: false
          format: sarif
          additional_args: --minimum-severity MEDIUM
      
      - name: Upload tfsec results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
      
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          output_format: cli,sarif
          soft_fail: false
          skip_check: CKV_GCP_*  

  python-lint:
    name: Python Lint & Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        component: [models, api, pipelines]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy pytest pytest-cov
          if [ -f ${{ matrix.component }}/requirements.txt ]; then
            pip install -r ${{ matrix.component }}/requirements.txt
          fi
      
      - name: Run Black (code formatting)
        run: black --check --diff ${{ matrix.component }}/
        continue-on-error: true
      
      - name: Run Flake8 (linting)
        run: flake8 ${{ matrix.component }}/ --max-line-length=100 --exclude=__pycache__
        continue-on-error: true
      
      - name: Run MyPy (type checking)
        run: mypy ${{ matrix.component }}/ --ignore-missing-imports
        continue-on-error: true
      
      - name: Run unit tests
        run: |
          if [ -d ${{ matrix.component }}/tests ]; then
            pytest ${{ matrix.component }}/tests/ --cov=${{ matrix.component }} --cov-report=xml --cov-report=term
          fi
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage.xml
          flags: ${{ matrix.component }}
          name: ${{ matrix.component }}-coverage

  
  docker-build-test:
    name: Test Docker Builds
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        dockerfile:
          - { path: 'models/claim-leakage/training', name: 'training' }
          - { path: 'api', name: 'api' }
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.dockerfile.path }}
          file: ${{ matrix.dockerfile.path }}/Dockerfile
          push: false
          tags: ${{ matrix.dockerfile.name }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.dockerfile.name }}:test
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-security]
    
    strategy:
      matrix:
        environment: [dev, staging, prod]
    
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          project_id: manypets-ml-${{ matrix.environment }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        run: terraform init
        working-directory: terraform/environments/${{ matrix.environment }}
      
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -out=tfplan-${{ matrix.environment }} | tee plan-output.txt
        working-directory: terraform/environments/${{ matrix.environment }}
        continue-on-error: true
      
      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.environment }}
          path: terraform/environments/${{ matrix.environment }}/tfplan-${{ matrix.environment }}
          retention-days: 5
      
      - name: Post plan to PR comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/environments/${{ matrix.environment }}/plan-output.txt', 'utf8');
            const truncatedPlan = planOutput.length > 65000 ? planOutput.substring(0, 65000) + '\n...(truncated)' : planOutput;
            
            const output = `### Terraform Plan: ${{ matrix.environment }}
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  all-checks-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: 
      - terraform-validate
      - terraform-security
      - python-lint
      - docker-build-test
      - terraform-plan
    
    steps:
      - name: All checks passed
        run: echo "‚úÖ All CI checks passed successfully!"