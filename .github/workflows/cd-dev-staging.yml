name: CD - Deploy to Dev & Staging

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger
    inputs:
      skip_dev:
        description: 'Skip dev deployment'
        required: false
        default: false
        type: boolean
      skip_staging:
        description: 'Skip staging deployment'
        required: false
        default: false
        type: boolean

env:
  TERRAFORM_VERSION: '1.5.7'
  PYTHON_VERSION: '3.11'
  GCP_REGION: 'europe-west2'

jobs:
  # Job 1: Build and Push Docker Images
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    outputs:
      training_image_tag: ${{ steps.meta-training.outputs.tags }}
      api_image_tag: ${{ steps.meta-api.outputs.tags }}
      image_version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate version tag
        id: version
        run: |
          VERSION=$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker to use gcloud as credential helper
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Build Training Image
      - name: Docker metadata for training image
        id: meta-training
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-dev/training-images/claim-leakage-training
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.version }}
      
      - name: Build and push training image
        uses: docker/build-push-action@v5
        with:
          context: models/claim-leakage/training
          file: models/claim-leakage/training/Dockerfile
          push: true
          tags: ${{ steps.meta-training.outputs.tags }}
          labels: ${{ steps.meta-training.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
      
      # Build API Image
      - name: Docker metadata for API image
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-dev/serving-images/prediction-api
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.version }}
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: api
          file: api/Dockerfile
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
      
      - name: Summary
        run: |
          echo "###  Docker Images Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Training Image:** \`${{ steps.meta-training.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**API Image:** \`${{ steps.meta-api.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # Job 2: Deploy to Dev
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build-and-push
    if: ${{ !inputs.skip_dev }}
    environment:
      name: dev
      url: https://claim-prediction-api-dev-xxxxx.run.app
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud (Dev)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: cicd-pipeline-dev@manypets-ml-dev.iam.gserviceaccount.com
          project_id: manypets-ml-dev
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        run: terraform init
        working-directory: terraform/environments/dev
      
      - name: Terraform Apply
        run: |
          terraform apply -auto-approve \
            -var="api_container_image=${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-dev/serving-images/prediction-api:${{ needs.build-and-push.outputs.image_version }}" \
            -var="training_container_image=${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-dev/training-images/claim-leakage-training:${{ needs.build-and-push.outputs.image_version }}"
        working-directory: terraform/environments/dev
      
      - name: Get Cloud Run URL
        id: get-url
        run: |
          URL=$(gcloud run services describe claim-prediction-api-dev \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
      
      - name: Wait for deployment to stabilize
        run: sleep 30
      
      - name: Run smoke tests
        run: |
          # Health check
          curl -f ${{ steps.get-url.outputs.url }}/health || exit 1
          
          # Test prediction endpoint (with dummy data)
          curl -X POST ${{ steps.get-url.outputs.url }}/predict/claim-leakage \
            -H "Content-Type: application/json" \
            -d '{"claim_amount": 1000, "policy_age": 12}' \
            -f || exit 1
          
          echo " Smoke tests passed!"
      
      - name: Deployment summary
        run: |
          echo "###  Dev Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Dev" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Version:** \`${{ needs.build-and-push.outputs.image_version }}\`" >> $GITHUB_STEP_SUMMARY

  # Job 3: Run Training Job in Dev
  train-model-dev:
    name: Train Model in Dev
    runs-on: ubuntu-latest
    needs: deploy-dev
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud (Dev)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: cicd-pipeline-dev@manypets-ml-dev.iam.gserviceaccount.com
          project_id: manypets-ml-dev
      
      - name: Trigger Vertex AI Training Job
        run: |
          gcloud ai custom-jobs create \
            --region=${{ env.GCP_REGION }} \
            --display-name="claim-leakage-training-${{ github.sha }}" \
            --worker-pool-spec="machine-type=n1-standard-4,replica-count=1,container-image-uri=${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-dev/training-images/claim-leakage-training:${{ needs.build-and-push.outputs.image_version }}" \
            --service-account=vertex-ai-training-dev@manypets-ml-dev.iam.gserviceaccount.com
      
      - name: Training job summary
        run: |
          echo "### üéØ Training Job Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Dev" >> $GITHUB_STEP_SUMMARY
          echo "**Job Name:** \`claim-leakage-training-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # Job 4: Copy images to staging registry
  promote-images-to-staging:
    name: Promote Images to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-dev, train-model-dev]
    if: ${{ !inputs.skip_staging }}
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Copy training image to staging
        run: |
          gcloud container images add-tag \
            ${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-dev/training-images/claim-leakage-training:${{ needs.build-and-push.outputs.image_version }} \
            ${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-staging/training-images/claim-leakage-training:${{ needs.build-and-push.outputs.image_version }} \
            --quiet
      
      - name: Copy API image to staging
        run: |
          gcloud container images add-tag \
            ${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-dev/serving-images/prediction-api:${{ needs.build-and-push.outputs.image_version }} \
            ${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-staging/serving-images/prediction-api:${{ needs.build-and-push.outputs.image_version }} \
            --quiet

  # Job 5: Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push, promote-images-to-staging]
    if: ${{ !inputs.skip_staging }}
    environment:
      name: staging
      url: https://claim-prediction-api-staging-xxxxx.run.app
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud (Staging)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: cicd-pipeline-staging@manypets-ml-staging.iam.gserviceaccount.com
          project_id: manypets-ml-staging
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        run: terraform init
        working-directory: terraform/environments/staging
      
      - name: Terraform Apply
        run: |
          terraform apply -auto-approve \
            -var="api_container_image=${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-staging/serving-images/prediction-api:${{ needs.build-and-push.outputs.image_version }}" \
            -var="training_container_image=${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-staging/training-images/claim-leakage-training:${{ needs.build-and-push.outputs.image_version }}"
        working-directory: terraform/environments/staging
      
      - name: Get Cloud Run URL
        id: get-url
        run: |
          URL=$(gcloud run services describe claim-prediction-api-staging \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
      
      - name: Wait for deployment to stabilize
        run: sleep 30
      
      - name: Run integration tests
        run: |
          # Health check
          curl -f ${{ steps.get-url.outputs.url }}/health || exit 1
          
          # Load test with Apache Bench
          ab -n 100 -c 10 ${{ steps.get-url.outputs.url }}/health
          
          # Test prediction endpoint
          curl -X POST ${{ steps.get-url.outputs.url }}/predict/claim-leakage \
            -H "Content-Type: application/json" \
            -d '{"claim_amount": 1000, "policy_age": 12}' \
            -f || exit 1
          
          echo " Integration tests passed!"
      
      - name: Deployment summary
        run: |
          echo "### Staging Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Version:** \`${{ needs.build-and-push.outputs.image_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ **Ready for production deployment!**" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify team (Slack)
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"Staging deployment successful! Version: \`${{ needs.build-and-push.outputs.image_version }}\` is ready for production approval.\"}"

  # Job 6: Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    if: ${{ !inputs.skip_staging }}
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --oneline --pretty=format:"- %s" HEAD~10..HEAD)
          else
            CHANGELOG=$(git log --oneline --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.build-and-push.outputs.image_version }}
          release_name: Release v${{ needs.build-and-push.outputs.image_version }}
          body: |
            ## Release v${{ needs.build-and-push.outputs.image_version }}
            
            ### Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ### Docker Images
            - **Training Image:** `${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-staging/training-images/claim-leakage-training:${{ needs.build-and-push.outputs.image_version }}`
            - **API Image:** `${{ env.GCP_REGION }}-docker.pkg.dev/manypets-ml-staging/serving-images/prediction-api:${{ needs.build-and-push.outputs.image_version }}`
            
            ### Deployments
            - ‚úÖ Dev: Deployed and tested
            - ‚úÖ Staging: Deployed and tested
            - ‚è≥ Prod: Awaiting manual approval
            
            To deploy to production, run the "Deploy to Production" workflow manually.
          draft: false
          prerelease: false